#!/usr/bin/env bash

HERE="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"

. $HERE/../shibumi/functions

[[ "$VERBOSE" == "1" ]] && set -x

fix_variants() {
	if [[ ! -z $PYTHON3 ]]; then
		[[ -z $PYTHON && "$PYTHON_VER" == "3"  ]] && ln -s $PYTHON /usr/local/bin/python
	fi
}

check_variants() {
	PYTHON=$(command -v python)
	PYTHON3=$(command -v python3)

	MYPY=""
	PYTHON_VER=""
	
	if [ ! -z $PYTHON ]; then
		PYTHON_VER="$(python --version 2>&1 | cut -d" " -f2 | cut -d. -f1)"
		[[ "$PYTHON_VER" == "3" ]] && MYPY=$PYTHON
	fi
	
	[[ ! -z $PYTHON3 ]] && MYPY=$PYTHON3
	
	[[ ! -z $FIX ]] && fix_variants
}

install_python() {
	if [[ ! -z $(command -v apt-get) ]]; then
		runn apt-get -qq update
		runn apt-get -qq install -y python3
	elif [[ ! -z $(command -v dnf) ]]; then
		runn dnf install -y python3
	elif [[ ! -z $(command -v yum) ]]; then
		runn yum install -y epel-release
		runn yum install -y python36
	elif [[ ! -z $(command -v apk) ]]; then
		runn apk update
		runn apk add python3
	elif [[ ! -z $(command -v brew) ]]; then
		runn brew install python3
	elif [[ ! -z $(command -v pkg) ]]; then
		runn pkg install -y python3
	fi
}

install_pip() {
	[[ "$PIP" != "1" ]] && return
	[[ $($MYPY -m pip --version > /dev/null 2>&1; echo $?) == 0 ]] && return

	local packs="ca-certificates wget"

	if [[ ! -z $(command -v apt-get) ]]; then
		runn apt-get -qq update
		runn apt-get -qq install -y $packs
		if [[ -z $(apt-cache search --names-only '^python3-distutils$')  ]]; then
			runn apt-get -qq install -y python3-distutils
		fi
	elif [[ ! -z $(command -v dnf) ]]; then
		runn dnf install -y $packs
	elif [[ ! -z $(command -v yum) ]]; then
		runn yum install -y $packs
	elif [[ ! -z $(command -v apk) ]]; then
		runn apk update
		runn apk add $packs
	elif [[ ! -z $(command -v brew) ]]; then
		runn brew install wget
	elif [[ ! -z $(command -v pkg) ]]; then
		runn pkg install -y $packs
	fi

	runn wget -q -O /tmp/get-pip.py https://bootstrap.pypa.io/get-pip.py
	runn $MYPY /tmp/get-pip.py
	rm -f /tmp/get-pip.py
}

check_variants

[[ ! -z "$MYPY" ]] && exit 0
[[ $CHECK == 1 ]] && exit 1

install_python

check_variants
if [[ -z $(command -v $MYPY) ]]; then
	>&2 echo "Cannot install Python3. Aborting."
	exit 1
fi

install_pip

exit 0
