#!/bin/bash

PROGNAME="${BASH_SOURCE[0]}"
HERE="$(cd "$(dirname "$PROGNAME")" &>/dev/null && pwd)"
READIES=$(cd $HERE/.. && pwd)
. $READIES/shibumi/defs

if [[ $1 == --help || $1 == help || $HELP == 1 ]]; then
	cat <<-'END'
		Install Anaconda (and GCC) via Miniforge 

		[ARGVARS...] getconda [--help|help]

		Argument variables:
		CONDA_DIR=dir   Install into `dir` (default: /opt/miniforge)
		POST=1          Perform only post-installation (idempotent)
		NOP=1           Do not execute, just print commands
		V|VERBOSE=1     Print commands
		HELP=1          Print help

		Notes:
		This installs profile.d script. Invoke `bash -l` to activate.
	END
	exit 0
fi

CONDA_DIR=${CONDA_DIR:-/opt/miniforge}
if [[ -e $CONDA_DIR && $POST != 1 ]]; then
	eprint "$CONDA_DIR exists. Aboring."
	exit 1
fi

OP=""
[[ $NOP == 1 ]] && OP=echo

# https://github.com/conda-forge/miniforge
# https://docs.anaconda.com/anaconda/install/silent-mode
# https://conda.io/projects/conda-build/en/latest/resources/compiler-tools.html
# https://docs.conda.io/en/latest/miniconda.html

[[ $NOP != 1 ]] && $SUDO echo

if [[ $POST != 1 ]]; then
	runn $READIES/bin/getget
	shfile=$(mktemp /tmp/miniforge.XXXXXX)
	runn wget -O $shfile https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-$(uname)-$(uname -m).sh
	runn $SUDO bash $shfile -b -p $CONDA_DIR
	rm $shfile
	runn $SUDO $CONDA_DIR/bin/conda install -y -c conda-forge gcc gxx tar
fi
# . $CONDA_DIR/bin/activate

cd $CONDA_DIR
[[ -d xbin ]] && runn $SUDO rm -rf xbin
runn $SUDO mkdir -p xbin
cd bin
for f in `ls x86_64-conda-linux-gnu-*`; do
	ff=${f/x86_64-conda-linux-gnu-/}
	runn $SUDO $READIES/bin/symlink -f --target $CONDA_DIR/bin/$f --link $CONDA_DIR/xbin/$ff
done
cd $HERE

if (( $(tar --version | head -1 | grep -i gnu | cut -d" " -f4 | cut -d. -f2) < 32 )); then
	runn $SUDO $READIES/bin/symlink -f --target $CONDA_DIR/bin/tar --link $CONDA_DIR/xbin/tar
fi

tmp_profiled=$(mktemp -d)
cat <<-END > $tmp_profiled/miniforge.sh
	. $CONDA_DIR/etc/profile.d/conda.sh
	export PATH=$CONDA_DIR/xbin:$PATH
	END
add_to_profile_d $tmp_profiled/miniforge.sh
rm -rf $tmp_profiled
